name: Terraform Infrastructure CI/CD

on:
  push:
    branches:
      - main
      - infra
    paths:
      - 'global/**'
      - 'Seoul/**'
      - 'Tokyo/**'
      - 'Azure/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'global/**'
      - 'Seoul/**'
      - 'Tokyo/**'
      - 'Azure/**'
  workflow_dispatch:
    inputs:
      module:
        description: 'ë°°í¬í•  ëª¨ë“ˆ ì„ íƒ'
        required: true
        type: choice
        options:
          - all
          - s3
          - vpc
          - seoul
          - tokyo
          - aurora
          - tgw-peering
          - dms
          - cloudfront
          - route53
          - azure
      action:
        description: 'Terraform ì•¡ì…˜'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: plan
      confirm_destroy:
        description: 'âš ï¸ Destroy í™•ì¸ (destroy ì„ íƒ ì‹œ "yes" ìž…ë ¥)'
        required: false
        type: string
        default: ''

env:
  TF_VERSION: "1.6.0"
  AWS_REGION: "ap-northeast-2"

jobs:
  # ===== ë³€ê²½ ê°ì§€ =====
  detect-changes:
    name: "ðŸ” Detect Changes"
    runs-on: ubuntu-latest
    outputs:
      s3: ${{ steps.filter.outputs.s3 }}
      vpc: ${{ steps.filter.outputs.vpc }}
      seoul: ${{ steps.filter.outputs.seoul }}
      tokyo: ${{ steps.filter.outputs.tokyo }}
      aurora: ${{ steps.filter.outputs.aurora }}
      tgw-peering: ${{ steps.filter.outputs.tgw-peering }}
      dms: ${{ steps.filter.outputs.dms }}
      cloudfront: ${{ steps.filter.outputs.cloudfront }}
      route53: ${{ steps.filter.outputs.route53 }}
      azure: ${{ steps.filter.outputs.azure }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            s3:
              - 'global/s3/**'
            vpc:
              - 'global/vpc/**'
            seoul:
              - 'Seoul/**'
            tokyo:
              - 'Tokyo/**'
            aurora:
              - 'global/aurora/**'
            tgw-peering:
              - 'global/tgw-peering/**'
            dms:
              - 'global/dms/**'
            cloudfront:
              - 'global/cloudfront/**'
            route53:
              - 'global/route53/**'
            azure:
              - 'Azure/**'

  # ===== Stage 1: Global S3 Backend =====
  global-s3:
    name: "1. Global S3 Backend"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.s3 == 'true' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.module == 's3' || github.event.inputs.module == 'all'))
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: global/s3
        run: terraform init

      - name: Terraform Validate
        working-directory: global/s3
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action != 'destroy'
        working-directory: global/s3
        run: terraform plan -out=tfplan -no-color

      - name: Terraform Plan Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/s3
        run: terraform plan -destroy -out=tfplan -no-color

      - name: Terraform Apply
        if: |
          (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/infra')) ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        working-directory: global/s3
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/s3
        run: terraform apply -auto-approve tfplan

  # ===== Stage 2: Global VPC =====
  global-vpc:
    name: "2. Global VPC"
    runs-on: ubuntu-latest
    needs: [detect-changes, global-s3]
    if: |
      always() &&
      (needs.global-s3.result == 'success' || needs.global-s3.result == 'skipped') &&
      (
        needs.detect-changes.outputs.vpc == 'true' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.module == 'vpc' || github.event.inputs.module == 'all'))
      )
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: global/vpc
        run: terraform init

      - name: Terraform Validate
        working-directory: global/vpc
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action != 'destroy'
        working-directory: global/vpc
        run: terraform plan -out=tfplan -no-color

      - name: Terraform Plan Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/vpc
        run: terraform plan -destroy -out=tfplan -no-color

      - name: Terraform Apply
        if: |
          (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/infra')) ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        working-directory: global/vpc
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/vpc
        run: terraform apply -auto-approve tfplan

  # ===== Stage 3: Seoul Region =====
  seoul:
    name: "3. Seoul Region"
    runs-on: ubuntu-latest
    needs: [detect-changes, global-vpc]
    if: |
      always() &&
      (needs.global-vpc.result == 'success' || needs.global-vpc.result == 'skipped') &&
      (
        needs.detect-changes.outputs.seoul == 'true' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.module == 'seoul' || github.event.inputs.module == 'all'))
      )
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create tfvars
        working-directory: Seoul
        run: |
          cat > terraform.tfvars << EOF
          seoul_key_name       = "${{ secrets.SEOUL_KEY_NAME }}"
          ssh_private_key_path = "./cheonsangyeon.pem"
          EOF

      - name: Terraform Init
        working-directory: Seoul
        run: terraform init

      - name: Terraform Validate
        working-directory: Seoul
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action != 'destroy'
        working-directory: Seoul
        run: terraform plan -out=tfplan -no-color

      - name: Terraform Plan Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: Seoul
        run: terraform plan -destroy -out=tfplan -no-color

      - name: Terraform Apply
        if: |
          (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/infra')) ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        working-directory: Seoul
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: Seoul
        run: terraform apply -auto-approve tfplan

  # ===== Stage 4: Tokyo Region =====
  tokyo:
    name: "4. Tokyo Region"
    runs-on: ubuntu-latest
    needs: [detect-changes, seoul]
    if: |
      always() &&
      (needs.seoul.result == 'success' || needs.seoul.result == 'skipped') &&
      (
        needs.detect-changes.outputs.tokyo == 'true' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.module == 'tokyo' || github.event.inputs.module == 'all'))
      )
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Create tfvars
        working-directory: Tokyo
        run: |
          cat > terraform.tfvars << EOF
          tokyo_key_name       = "${{ secrets.TOKYO_KEY_NAME }}"
          ssh_private_key_path = "./cheonsangyeonjapan.pem"
          EOF

      - name: Terraform Init
        working-directory: Tokyo
        run: terraform init

      - name: Terraform Validate
        working-directory: Tokyo
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action != 'destroy'
        working-directory: Tokyo
        run: terraform plan -out=tfplan -no-color

      - name: Terraform Plan Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: Tokyo
        run: terraform plan -destroy -out=tfplan -no-color

      - name: Terraform Apply
        if: |
          (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/infra')) ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        working-directory: Tokyo
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: Tokyo
        run: terraform apply -auto-approve tfplan

  # ===== Stage 5a: Global Aurora (Parallel) =====
  global-aurora:
    name: "5a. Global Aurora"
    runs-on: ubuntu-latest
    needs: [detect-changes, tokyo]
    if: |
      always() &&
      (needs.tokyo.result == 'success' || needs.tokyo.result == 'skipped') &&
      (
        needs.detect-changes.outputs.aurora == 'true' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.module == 'aurora' || github.event.inputs.module == 'all'))
      )
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: global/aurora
        run: terraform init

      - name: Terraform Validate
        working-directory: global/aurora
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action != 'destroy'
        working-directory: global/aurora
        run: terraform plan -out=tfplan -no-color

      - name: Terraform Plan Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/aurora
        run: terraform plan -destroy -out=tfplan -no-color

      - name: Terraform Apply
        if: |
          (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/infra')) ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        working-directory: global/aurora
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/aurora
        run: terraform apply -auto-approve tfplan

  # ===== Stage 5b: TGW Peering (Parallel) =====
  tgw-peering:
    name: "5b. TGW Peering"
    runs-on: ubuntu-latest
    needs: [detect-changes, tokyo]
    if: |
      always() &&
      (needs.tokyo.result == 'success' || needs.tokyo.result == 'skipped') &&
      (
        needs.detect-changes.outputs.tgw-peering == 'true' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.module == 'tgw-peering' || github.event.inputs.module == 'all'))
      )
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: global/tgw-peering
        run: terraform init

      - name: Terraform Validate
        working-directory: global/tgw-peering
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action != 'destroy'
        working-directory: global/tgw-peering
        run: terraform plan -out=tfplan -no-color

      - name: Terraform Plan Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/tgw-peering
        run: terraform plan -destroy -out=tfplan -no-color

      - name: Terraform Apply
        if: |
          (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/infra')) ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        working-directory: global/tgw-peering
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/tgw-peering
        run: terraform apply -auto-approve tfplan

  # ===== Stage 6: Global DMS =====
  global-dms:
    name: "6. Global DMS"
    runs-on: ubuntu-latest
    needs: [detect-changes, global-aurora, tgw-peering]
    if: |
      always() &&
      (needs.global-aurora.result == 'success' || needs.global-aurora.result == 'skipped') &&
      (needs.tgw-peering.result == 'success' || needs.tgw-peering.result == 'skipped') &&
      (
        needs.detect-changes.outputs.dms == 'true' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.module == 'dms' || github.event.inputs.module == 'all'))
      )
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: global/dms
        run: terraform init

      - name: Terraform Validate
        working-directory: global/dms
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action != 'destroy'
        working-directory: global/dms
        run: terraform plan -out=tfplan -no-color

      - name: Terraform Plan Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/dms
        run: terraform plan -destroy -out=tfplan -no-color

      - name: Terraform Apply
        if: |
          (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/infra')) ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        working-directory: global/dms
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/dms
        run: terraform apply -auto-approve tfplan

  # ===== Stage 7: Global CloudFront =====
  global-cloudfront:
    name: "7. Global CloudFront"
    runs-on: ubuntu-latest
    needs: [detect-changes, global-dms]
    if: |
      always() &&
      (needs.global-dms.result == 'success' || needs.global-dms.result == 'skipped') &&
      (
        needs.detect-changes.outputs.cloudfront == 'true' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.module == 'cloudfront' || github.event.inputs.module == 'all'))
      )
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: global/cloudfront
        run: terraform init

      - name: Terraform Validate
        working-directory: global/cloudfront
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action != 'destroy'
        working-directory: global/cloudfront
        run: terraform plan -out=tfplan -no-color

      - name: Terraform Plan Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/cloudfront
        run: terraform plan -destroy -out=tfplan -no-color

      - name: Terraform Apply
        if: |
          (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/infra')) ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        working-directory: global/cloudfront
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/cloudfront
        run: terraform apply -auto-approve tfplan

  # ===== Stage 8: Global Route53 =====
  global-route53:
    name: "8. Global Route53"
    runs-on: ubuntu-latest
    needs: [detect-changes, global-cloudfront]
    if: |
      always() &&
      (needs.global-cloudfront.result == 'success' || needs.global-cloudfront.result == 'skipped') &&
      (
        needs.detect-changes.outputs.route53 == 'true' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.module == 'route53' || github.event.inputs.module == 'all'))
      )
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: global/route53
        run: terraform init

      - name: Terraform Validate
        working-directory: global/route53
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action != 'destroy'
        working-directory: global/route53
        run: terraform plan -out=tfplan -no-color

      - name: Terraform Plan Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/route53
        run: terraform plan -destroy -out=tfplan -no-color

      - name: Terraform Apply
        if: |
          (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/infra')) ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        working-directory: global/route53
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: global/route53
        run: terraform apply -auto-approve tfplan

  # ===== Stage 9: Azure DR Infrastructure =====
  azure:
    name: "9. Azure DR"
    runs-on: ubuntu-latest
    needs: [detect-changes, global-route53]
    if: |
      always() &&
      (needs.global-route53.result == 'success' || needs.global-route53.result == 'skipped') &&
      (
        needs.detect-changes.outputs.azure == 'true' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.module == 'azure' || github.event.inputs.module == 'all'))
      )
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create tfvars
        working-directory: Azure
        run: |
          cat > terraform.tfvars << EOF
          mysql_admin_username = "${{ secrets.AZURE_MYSQL_USERNAME }}"
          mysql_admin_password = "${{ secrets.AZURE_MYSQL_PASSWORD }}"
          vpn_shared_key       = "${{ secrets.VPN_SHARED_KEY }}"
          alert_email          = "${{ secrets.ALERT_EMAIL }}"
          EOF

      - name: Terraform Init
        working-directory: Azure
        run: terraform init

      - name: Terraform Validate
        working-directory: Azure
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action != 'destroy'
        working-directory: Azure
        run: terraform plan -out=tfplan -no-color

      - name: Terraform Plan Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: Azure
        run: terraform plan -destroy -out=tfplan -no-color

      - name: Terraform Apply
        if: |
          (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/infra')) ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        working-directory: Azure
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy' && github.event.inputs.confirm_destroy == 'yes'
        working-directory: Azure
        run: terraform apply -auto-approve tfplan

  # ===== Summary =====
  summary:
    name: "ðŸ“Š Deployment Summary"
    runs-on: ubuntu-latest
    needs: [detect-changes, global-s3, global-vpc, seoul, tokyo, global-aurora, tgw-peering, global-dms, global-cloudfront, global-route53, azure]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Terraform Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” ë³€ê²½ ê°ì§€ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "| ëª¨ë“ˆ | ë³€ê²½ë¨ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| S3 | ${{ needs.detect-changes.outputs.s3 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VPC | ${{ needs.detect-changes.outputs.vpc }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Seoul | ${{ needs.detect-changes.outputs.seoul }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tokyo | ${{ needs.detect-changes.outputs.tokyo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Aurora | ${{ needs.detect-changes.outputs.aurora }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TGW Peering | ${{ needs.detect-changes.outputs.tgw-peering }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DMS | ${{ needs.detect-changes.outputs.dms }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CloudFront | ${{ needs.detect-changes.outputs.cloudfront }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Route53 | ${{ needs.detect-changes.outputs.route53 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Azure | ${{ needs.detect-changes.outputs.azure }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Module | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Global S3 | ${{ needs.global-s3.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | Global VPC | ${{ needs.global-vpc.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | Seoul | ${{ needs.seoul.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | Tokyo | ${{ needs.tokyo.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5a | Global Aurora | ${{ needs.global-aurora.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5b | TGW Peering | ${{ needs.tgw-peering.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 6 | Global DMS | ${{ needs.global-dms.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 7 | Global CloudFront | ${{ needs.global-cloudfront.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 8 | Global Route53 | ${{ needs.global-route53.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 9 | Azure DR | ${{ needs.azure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Œ ë‹´ë‹¹ìžë³„ ëª¨ë“ˆ" >> $GITHUB_STEP_SUMMARY
          echo "| ë‹´ë‹¹ìž | ëª¨ë“ˆ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ì¸í”„ë¼ | S3, VPC, Seoul, Tokyo, TGW-Peering |" >> $GITHUB_STEP_SUMMARY
          echo "| í”„ë¡ íŠ¸/ë°±ì—”ë“œ | CloudFront, Route53 |" >> $GITHUB_STEP_SUMMARY
          echo "| ëžŒë‹¤ ë‹´ë‹¹ìž | (ë³„ë„ ì›Œí¬í”Œë¡œìš° ê¶Œìž¥) |" >> $GITHUB_STEP_SUMMARY
          echo "| DB/DMS | Aurora, DMS |" >> $GITHUB_STEP_SUMMARY
          echo "| Azure DR | Azure |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ ì£¼ì˜ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
          echo "- **skipped**: í•´ë‹¹ ëª¨ë“ˆì˜ íŒŒì¼ì´ ë³€ê²½ë˜ì§€ ì•Šì•„ ê±´ë„ˆëœ€ (ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ìœ ì§€)" >> $GITHUB_STEP_SUMMARY
          echo "- **success**: ë³€ê²½ì‚¬í•­ ì ìš© ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- ECR App ServiceëŠ” EKS ë‹´ë‹¹ìž ë°°í¬ í›„ ë³„ë„ë¡œ ë°°í¬í•´ì•¼ í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
